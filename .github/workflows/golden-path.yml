name: On-Running DevSecOps Golden Path (Artifacts Edition)

# üöÄ DISPARADORES (TRIGGERS)
# Se ejecuta en cada push a la rama main y en cada Pull Request.
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ====================================================
  # üîê JOB 1: DETECCI√ìN DE SECRETOS (Gitleaks)
  # Busca contrase√±as, API Keys o tokens hardcodeados.
  # ====================================================
  secret-scan:
    name: üïµÔ∏è Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Importante: Bajar todo el historial git
      
      # Ejecuta Gitleaks y genera un reporte JSON
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # --report-path guarda el resultado en un archivo
          args: detect --report-path=gitleaks-report.json --redact --verbose
        continue-on-error: true # AUDIT MODE: No rompe el pipeline si encuentra algo

      # Sube el JSON como "Artefacto" para usarlo despu√©s
      - name: Upload Gitleaks Report
        uses: actions/upload-artifact@v3
        if: always() # Se ejecuta aunque Gitleaks falle
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  # ====================================================
  # üì¶ JOB 2: AN√ÅLISIS DE DEPENDENCIAS - SCA (Trivy)
  # Busca librer√≠as viejas o vulnerables en requirements.txt
  # ====================================================
  dependency-scan:
    name: üì¶ SCA (Dependencies)
    runs-on: ubuntu-latest
    needs: secret-scan
    if: always()
    steps:
      - uses: actions/checkout@v3
      
      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'           # Queremos JSON para DefectDojo
          output: 'trivy-report.json'
          exit-code: '0'           # 0 = No romper el build (Audit Mode)
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: trivy-report
          path: trivy-report.json

  # ====================================================
  # üêç JOB 3: AN√ÅLISIS DE C√ìDIGO - SAST (Semgrep)
  # Busca patrones de c√≥digo inseguro (inyecci√≥n SQL, RCE...)
  # ====================================================
  code-scan:
    name: üõ°Ô∏è SAST (Code)
    runs-on: ubuntu-latest
    needs: secret-scan
    if: always()
    steps:
      - uses: actions/checkout@v3
      
      # Instalamos Semgrep manualmente para tener control total
      - name: Install Semgrep
        run: pip install semgrep

      # Generamos el reporte JSON
      - name: Run Semgrep
        run: semgrep scan --config=p/python --json --output=semgrep-report.json
        continue-on-error: true

      - name: Upload Semgrep Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: semgrep-report
          path: semgrep-report.json

  # ====================================================
  # üê≥ JOB 4: SEGURIDAD DE CONTENEDORES
  # Construye la imagen Docker y la escanea con Trivy
  # ====================================================
  container-scan:
    name: üê≥ Container Security
    runs-on: ubuntu-latest
    needs: secret-scan
    if: always()
    steps:
      - uses: actions/checkout@v3
      
      # Paso 1: Construir la imagen localmente
      - name: Build Docker Image
        run: docker build -t my-app:${{ github.sha }} .
      
      # Paso 2: Escanear esa imagen
      - name: Run Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'my-app:${{ github.sha }}'
          format: 'json'
          output: 'trivy-image.json'
          exit-code: '0'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Upload Container Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: trivy-image-report
          path: trivy-image.json

  # ====================================================
  # ‚òÅÔ∏è JOB 5: INFRAESTRUCTURA COMO C√ìDIGO (IaC)
  # Revisa archivos Terraform buscando nubes inseguras
  # ====================================================
  iac-scan:
    name: ‚òÅÔ∏è IaC Scan (Terraform)
    runs-on: ubuntu-latest
    needs: secret-scan
    if: always()
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: '.'
          soft_fail: true
          framework: terraform
          output_format: json
          output_file_path: checkov-report.json

      - name: Upload Checkov Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: checkov-report
          path: checkov-report.json

  # ====================================================
  # üìä JOB 6: CENTRALIZACI√ìN (DefectDojo)
  # Descarga todos los reportes y los env√≠a a tu servidor local
  # ====================================================
  defectdojo-upload:
    name: üìä Upload to DefectDojo
    runs-on: ubuntu-latest
    # Espera a que terminen TODOS los escaneos anteriores
    needs: [secret-scan, dependency-scan, code-scan, container-scan, iac-scan]
    if: always()
    steps:
      - uses: actions/checkout@v3
      
      # 1. Descargar los JSONs generados por los otros jobs
      # Se guardar√°n en carpetas: reports/trivy-report/trivy-report.json
      - uses: actions/download-artifact@v3
        with:
          path: reports

      # 2. Aplanar carpetas (Mover todos los .json a la ra√≠z)
      # Esto facilita que el script de Python los encuentre
      - name: Move Reports
        run: |
          find reports -name "*.json" -exec mv {} . \;
          ls -la *.json # Verificaci√≥n visual en los logs

      # 3. Ejecutar el script "Pegamento"
      - name: Run Upload Script
        env:
          DOJO_URL: ${{ secrets.DOJO_URL }}
          DOJO_API_KEY: ${{ secrets.DOJO_API_KEY }}
          DOJO_ENGAGEMENT_ID: "1"
        run: |
          pip install requests
          python scripts/upload_dojo.py