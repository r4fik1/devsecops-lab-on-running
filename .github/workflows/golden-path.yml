name: On-Running DevSecOps Golden Path

# üöÄ TRIGGER STRATEGY
# We run security scans on every push to main and every Pull Request.
# This ensures "Shift Left" security: catching issues before they reach production.
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # üîê JOB 1: SECRET SCANNING (Gitleaks)
  # STRATEGY: FAIL FAST
  # This runs first. If we find a hardcoded secret, we stop everything immediately.
  # There is no point in scanning for bugs if we just leaked an AWS Key.
  secret-scan:
    name: üïµÔ∏è Secret Detection (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # IMPORTANT: Fetch full history to detect secrets in previous commits, not just the current one.
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # If Gitleaks finds a secret, it returns exit code 1 and breaks the build here.

  # üì¶ JOB 2: SCA - SOFTWARE COMPOSITION ANALYSIS (Trivy)
  # Focus: Vulnerable Dependencies (e.g., old Flask version)
  dependency-scan:
    name: üì¶ Dependency Scanner (Trivy)
    runs-on: ubuntu-latest
    needs: secret-scan # DEPENDENCY: Only run if secrets are clean. Save CI minutes.
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs' # Filesystem scan (we are scanning code, not a built docker image yet)
          scan-ref: '.'
          format: 'table' # Human readable output in the CI logs
          exit-code: '1' # BLOCKING: Fail the pipeline if vulnerabilities are found
          ignore-unfixed: true # NOISE REDUCTION: Don't report bugs that have no patch available
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH' # POLICY: We only block for High/Critical issues.

  # üêç JOB 3: SAST - STATIC APPLICATION SECURITY TESTING (Semgrep)
  # Focus: Insecure Code Patterns (e.g., Command Injection, XSS)
  code-scan:
    name: üõ°Ô∏è Code Quality (Semgrep)
    runs-on: ubuntu-latest
    needs: secret-scan # Run in parallel with Trivy, but after Gitleaks
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Semgrep Security Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/python # Use the community-standard ruleset for Python
          # Semgrep will automatically detect the 'subprocess.call' injection in app.py