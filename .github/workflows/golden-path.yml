name: On-Running DevSecOps Golden Path (Artifacts Edition)

# üöÄ DISPARADORES
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ====================================================
  # üîê JOB 1: SECRET SCAN (Gitleaks)
  # ====================================================
  secret-scan:
    name: üïµÔ∏è Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # Actualizado a v4
        with:
          fetch-depth: 0

      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: detect --report-path=gitleaks-report.json --redact --verbose
        continue-on-error: true

      # CORRECCI√ìN: Usamos v4
      - name: Upload Gitleaks Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  # ====================================================
  # üì¶ JOB 2: SCA (Trivy)
  # ====================================================
  dependency-scan:
    name: üì¶ SCA (Dependencies)
    runs-on: ubuntu-latest
    needs: secret-scan
    if: always()
    steps:
      - uses: actions/checkout@v4 # Actualizado a v4
      
      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-report.json'
          exit-code: '0'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      # CORRECCI√ìN: Usamos v4
      - name: Upload Trivy Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report
          path: trivy-report.json

  # ====================================================
  # üêç JOB 3: SAST (Semgrep)
  # ====================================================
  code-scan:
    name: üõ°Ô∏è SAST (Code)
    runs-on: ubuntu-latest
    needs: secret-scan
    if: always()
    steps:
      - uses: actions/checkout@v4 # Actualizado a v4
      
      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep
        run: semgrep scan --config=p/python --json --output=semgrep-report.json
        continue-on-error: true

      # CORRECCI√ìN: Usamos v4
      - name: Upload Semgrep Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-report
          path: semgrep-report.json

  # ====================================================
  # üê≥ JOB 4: CONTAINER SECURITY
  # ====================================================
  container-scan:
    name: üê≥ Container Security
    runs-on: ubuntu-latest
    needs: secret-scan
    if: always()
    steps:
      - uses: actions/checkout@v4 # Actualizado a v4
      
      - name: Build Docker Image
        run: docker build -t my-app:${{ github.sha }} .
      
      - name: Run Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'my-app:${{ github.sha }}'
          format: 'json'
          output: 'trivy-image.json'
          exit-code: '0'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      # CORRECCI√ìN: Usamos v4
      - name: Upload Container Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-image-report
          path: trivy-image.json

  # ====================================================
  # ‚òÅÔ∏è JOB 5: IaC SECURITY (Checkov)
  # ====================================================
  iac-scan:
    name: ‚òÅÔ∏è IaC Scan (Terraform)
    runs-on: ubuntu-latest
    needs: secret-scan
    if: always()
    steps:
      - uses: actions/checkout@v4 # Actualizado a v4
      
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: '.'
          soft_fail: true
          framework: terraform
          output_format: json
          output_file_path: checkov-report.json

      # CORRECCI√ìN: Usamos v4
      - name: Upload Checkov Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkov-report
          path: checkov-report.json

  # ====================================================
  # üìä JOB 6: CENTRALIZACI√ìN (DefectDojo)
  # ====================================================
  defectdojo-upload:
    name: üìä Upload to DefectDojo
    runs-on: ubuntu-latest
    needs: [secret-scan, dependency-scan, code-scan, container-scan, iac-scan]
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      # CORRECCI√ìN: Usamos v4 para descargar
      - uses: actions/download-artifact@v4
        with:
          path: reports
          # En v4, por defecto crea carpetas por cada artefacto, 
          # pero nuestro script 'Move Reports' de abajo ya lo gestiona.

      - name: Move Reports
        run: |
          find reports -name "*.json" -exec mv {} . \;
          ls -la *.json

      - name: Run Upload Script
        env:
          DOJO_URL: ${{ secrets.DOJO_URL }}
          DOJO_API_KEY: ${{ secrets.DOJO_API_KEY }}
          DOJO_ENGAGEMENT_ID: "1"
        run: |
          pip install requests
          python scripts/upload_dojo.py